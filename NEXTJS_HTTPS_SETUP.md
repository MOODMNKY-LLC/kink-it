# Next.js HTTPS Development Server Setup

## üéØ Overview

This guide explains how to run the Next.js dev server in HTTPS mode for local development. This is separate from Supabase TLS configuration.

## ‚úÖ What's Already Configured

- **Supabase TLS**: ‚úÖ Correctly enabled in `supabase/config.toml` (`[api.tls] enabled = true`)
  - Supabase **auto-generates** certificates when TLS is enabled
  - No manual certificate creation needed for Supabase
  - Supabase runs on `https://127.0.0.1:55321`

## üöÄ Setting Up Next.js HTTPS

### Step 1: Install mkcert (Certificate Generator)

**Windows (using Chocolatey):**
\`\`\`bash
choco install mkcert
\`\`\`

**macOS (using Homebrew):**
\`\`\`bash
brew install mkcert
\`\`\`

**Linux:**
\`\`\`bash
# Ubuntu/Debian
sudo apt install libnss3-tools
wget -O mkcert https://github.com/FiloSottile/mkcert/releases/latest/download/mkcert-v1.4.4-linux-amd64
chmod +x mkcert
sudo mv mkcert /usr/local/bin/
\`\`\`

### Step 2: Create Local Certificate Authority

\`\`\`bash
mkcert -install
\`\`\`

This installs a local CA that your system will trust, eliminating browser security warnings.

### Step 3: Generate Certificates for Next.js

\`\`\`bash
# Create certs directory
mkdir -p certs

# Generate certificates for localhost and 127.0.0.1
mkcert -key-file certs/localhost+1-key.pem -cert-file certs/localhost+1.pem localhost 127.0.0.1
\`\`\`

This creates:
- `certs/localhost+1-key.pem` (private key)
- `certs/localhost+1.pem` (certificate)

### Step 4: Update .gitignore

Add certificates to `.gitignore` (they're local development only):

\`\`\`gitignore
# Local development certificates
certs/*.pem
certs/*.key
\`\`\`

### Step 5: Run the Dev Server

**HTTPS Mode (Recommended):**
\`\`\`bash
pnpm run dev
# or explicitly
pnpm run dev:https
\`\`\`

**HTTP Mode (Fallback):**
\`\`\`bash
pnpm run dev:http
\`\`\`

The server will start on `https://127.0.0.1:3000`

## üîç Verification

1. **Start the dev server**: `pnpm run dev`
2. **Open browser**: Navigate to `https://127.0.0.1:3000`
3. **No security warnings**: The certificate should be trusted automatically (thanks to mkcert)

## üìù Configuration Details

### Custom Server (`server.js`)

The custom server:
- Uses Node.js `https` module
- Loads certificates from `certs/` directory
- Wraps Next.js with HTTPS support
- Runs on `https://127.0.0.1:3000`

### Package.json Scripts

- `pnpm run dev` ‚Üí HTTPS server (uses `server.js`)
- `pnpm run dev:https` ‚Üí HTTPS server (explicit)
- `pnpm run dev:http` ‚Üí Standard HTTP server (fallback)

## üîÑ Supabase vs Next.js HTTPS

**Important Distinction:**

| Service | Configuration | Certificates |
|---------|--------------|--------------|
| **Supabase** | `supabase/config.toml` ‚Üí `[api.tls] enabled = true` | Auto-generated by Supabase |
| **Next.js** | `server.js` custom server | Generated by `mkcert` |

These are **separate** configurations:
- Supabase TLS handles OAuth callbacks (required for Notion)
- Next.js HTTPS provides full HTTPS development environment

## üêõ Troubleshooting

### Certificate Not Found Error

If you see:
\`\`\`
‚ùå Certificate files not found!
\`\`\`

**Solution:**
1. Make sure `mkcert` is installed
2. Run `mkcert -install` to create local CA
3. Generate certs: `mkcert -key-file certs/localhost+1-key.pem -cert-file certs/localhost+1.pem localhost 127.0.0.1`
4. Verify files exist in `certs/` directory

### Browser Security Warning

If you see certificate warnings:
1. Make sure you ran `mkcert -install` (installs trusted CA)
2. Restart your browser
3. Clear browser cache if needed

### Port Already in Use

If port 3000 is already in use:
1. Stop other Next.js processes
2. Or modify `server.js` to use a different port

### Fallback to HTTP

If HTTPS setup is problematic, you can always use:
\`\`\`bash
pnpm run dev:http
\`\`\`

This runs the standard Next.js HTTP dev server. Supabase will still use HTTPS for OAuth callbacks.

## ‚úÖ Summary

**What You Did Right:**
- ‚úÖ Enabled TLS in Supabase `config.toml` (correct!)
- ‚úÖ Supabase auto-generates certificates (no manual creation needed)

**What Was Missing:**
- Next.js HTTPS requires a custom server (now added)
- Next.js needs separate certificates (use `mkcert`)

**Result:**
- Supabase: `https://127.0.0.1:55321` (for OAuth)
- Next.js: `https://127.0.0.1:3000` (for full HTTPS dev)

---

**Status**: ‚úÖ Next.js HTTPS Setup Complete  
**Next**: Generate certificates with `mkcert` and run `pnpm run dev`
